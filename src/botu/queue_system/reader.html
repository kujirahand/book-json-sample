
<html><head><meta charset="utf-8"><title>整理券リーダー</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head><body>
    <h1>整理券リーダー</h1>
    <canvas id="canvas" width="400" height="400"></canvas>
    <h3><div id="info">カメラを許可してください。(HTTPSのサーバーに配置してください)</div></h3>
    <script>
    const video = document.createElement('video')
    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    const info = document.getElementById('info')
    // QRコードを認識した枠を描画
    function drawLine(begin, end, color) {
        ctx.beginPath();
        ctx.moveTo(begin.x, begin.y);
        ctx.lineTo(end.x, end.y);
        ctx.lineWidth = 4;
        ctx.strokeStyle = color;
        ctx.stroke();
    }
    // カメラからの情報を得る
    navigator.mediaDevices.getUserMedia({video: { facingMode: "environment" } })
    .then((stream) => {
          video.srcObject = stream
          video.setAttribute("playsinline", true)
          video.play()
          requestAnimationFrame(tick)
    })
    // 画面描画のタイミングでQRコードを認識する
    function tick() {
        if (video.readyState !== video.HAVE_ENOUGH_DATA) { return }
        // カメラをキャンバスに描画
        canvas.height = video.videoHeight
        canvas.width = video.videoWidth
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
        // 画像データを得る
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
        // QRコードの認識
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
        })
        if (code) {
            const red = '#FF0000'
            drawLine(code.location.topLeftCorner, 
                code.location.topRightCorner, red)
            drawLine(code.location.topRightCorner, 
                code.location.bottomRightCorner, red)
            drawLine(code.location.bottomRightCorner, 
                code.location.bottomLeftCorner, red)
            drawLine(code.location.bottomLeftCorner, 
                code.location.topLeftCorner, red)
            info.innerText = code.data;
        }
    }
    requestAnimationFrame(tick);
    </script>
</body></html>